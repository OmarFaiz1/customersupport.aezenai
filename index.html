<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Floating Chat Iframe</title>
    <style>
      /* Remove default page margin/padding */
      html,
      body {
        margin: 0;
        padding: 0;
      }

      /* When modal is open, prevent page scrolling */
      body.modal-active {
        overflow: hidden;
      }

      /* Hide scrollbars globally for WebKit browsers */
      ::-webkit-scrollbar {
        width: 0px;
        background: transparent;
      }
      ::-webkit-scrollbar-thumb {
        background: transparent;
      }

      /* For Firefox */
      * {
        scrollbar-width: none;
        -ms-overflow-style: none;
      }
    </style>
  </head>
  <body>
    <script>
      // Check if the user email is registered in the session
      fetch("/check-user", {
        credentials: "include",
      })
        .then((response) => response.json())
        .then((data) => {
          if (!data.email) {
            var email = prompt("Please enter your email for support:");
            if (email) {
              fetch("/register-email", {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                credentials: "include",
                body: JSON.stringify({ email: email }),
              })
                .then((response) => response.json())
                .then((regData) => {
                  console.log("Email registered:", regData);
                })
                .catch((err) => console.error("Error registering email:", err));
            }
          }
        })
        .catch((err) => console.error("Error checking user:", err));

      // Function to check if the user is on a mobile device
      function isMobile() {
        return window.innerWidth <= 768;
      }

      // Create iframe container for the main chat
      const iframeContainer = document.createElement("div");
      iframeContainer.style.position = "fixed";
      iframeContainer.style.bottom = "0px";
      iframeContainer.style.background = "#fff";
      iframeContainer.style.borderRadius = "8px";
      iframeContainer.style.boxShadow = "0px 4px 6px rgba(0, 0, 0, 0.1)";
      iframeContainer.style.zIndex = "999";
      iframeContainer.style.display = "block";
      iframeContainer.style.overflow = "hidden";

      if (isMobile()) {
        iframeContainer.style.width = "100vw";
        iframeContainer.style.height = "100vh";
        iframeContainer.style.left = "0";
        iframeContainer.style.transform = "none";
      } else {
        iframeContainer.style.width = "400px";
        iframeContainer.style.height = `${window.innerHeight}px`;
        iframeContainer.style.left = "50%";
        iframeContainer.style.transform = "translateX(-50%)";
      }

      iframeContainer.innerHTML = `
      <iframe id="chat-iframe" 
              src="https://chat.aezenai.com?aid=af2a896a-5517-48eb-b8f3-014eec338f38&lang=en"
              style="width: 100%; height: calc(100% - 30px); border: none;">
      </iframe>
      <div style="text-align: center; padding: 5px; font-size: 14px; background: #f1f1f1; color: #333;">
        Powered by <a href="https://aezenai.com" target="_blank" style="color: #007bff; text-decoration: none;">aezenai.com</a>
      </div>
      <button id="floating-btn" 
              style="position: absolute; bottom: 30px; left: 9px; width: 34px; height: 54px; 
                     background: transparent; border: none; border-radius: 50%; 
                     cursor: pointer; display: flex; align-items: center; justify-content: center;">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" 
             fill="none" stroke="transparent" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
          <polyline points="17 8 12 3 7 8"></polyline>
          <line x1="12" y1="3" x2="12" y2="15"></line>
        </svg>
      </button>
      <button id="track-order-btn" 
              style="position: absolute; top: 20px; right: 10px; padding: 10px 16px; 
                     background: #f8f9fa; border: 1px solid #007bff; border-radius: 4px; 
                     color: #007bff; font-size: 16px; cursor: pointer;">
        Track Order
      </button>
      `;

      document.body.appendChild(iframeContainer);

      const floatingBtn = iframeContainer.querySelector("#floating-btn");
      const trackOrderBtn = iframeContainer.querySelector("#track-order-btn");
      const chatIframe = iframeContainer.querySelector("#chat-iframe");

      // Log initial iframe URL
      console.log("Initial iframe URL:", chatIframe.src);

      // When floating button is clicked, open the Railway URL in a modal popup.
      floatingBtn.addEventListener("click", (event) => {
        event.preventDefault();
        
        // Retrieve the user email from /check-user
        fetch("/check-user", { credentials: "include" })
          .then((response) => response.json())
          .then((data) => {
            let emailParam = "";
            if (data.email) {
              emailParam = "?email=" + encodeURIComponent(data.email);
            }
            
            // Create modal overlay
            const modal = document.createElement("div");
            modal.id = "railway-modal";
            modal.style.position = "fixed";
            modal.style.top = "0";
            modal.style.left = "0";
            modal.style.width = "100%";
            modal.style.height = "100%";
            modal.style.backgroundColor = "rgba(0, 0, 0, 0.5)";
            modal.style.zIndex = "1000";
            modal.style.display = "flex";
            modal.style.justifyContent = "center";
            modal.style.alignItems = "center";

            // Create modal content container (small popup on desktop, responsive on mobile)
            const modalContent = document.createElement("div");
            if (isMobile()) {
              modalContent.style.width = "90vw";
              modalContent.style.height = "90vh";
            } else {
              modalContent.style.width = "300px";
              modalContent.style.height = "400px";
            }
            modalContent.style.backgroundColor = "#fff";
            modalContent.style.borderRadius = "8px";
            modalContent.style.overflow = "hidden";
            modalContent.style.position = "relative";

            // Create professional close button for modal
            const closeButton = document.createElement("button");
            closeButton.innerHTML = "&times;";
            closeButton.style.position = "absolute";
            closeButton.style.top = "10px";
            closeButton.style.right = "10px";
            closeButton.style.zIndex = "1001";
            closeButton.style.width = "30px";
            closeButton.style.height = "30px";
            closeButton.style.border = "none";
            closeButton.style.borderRadius = "50%";
            closeButton.style.backgroundColor = "#007bff";
            closeButton.style.color = "#fff";
            closeButton.style.fontSize = "20px";
            closeButton.style.cursor = "pointer";
            closeButton.style.boxShadow = "0 2px 4px rgba(0, 0, 0, 0.2)";
            closeButton.addEventListener("click", () => {
              modal.remove();
              document.body.classList.remove("modal-active");
            });

            // Create iframe for Railway URL with the appended email query parameter
            const railwayIframe = document.createElement("iframe");
            railwayIframe.src = "https://dockerautomation-production.up.railway.app/" + emailParam;
            railwayIframe.style.width = "100%";
            railwayIframe.style.height = "100%";
            railwayIframe.style.border = "none";

            // Assemble modal elements
            modalContent.appendChild(closeButton);
            modalContent.appendChild(railwayIframe);
            modal.appendChild(modalContent);
            document.body.appendChild(modal);

            // Disable page scroll
            document.body.classList.add("modal-active");

            console.log("Opened railway modal with URL:", railwayIframe.src);
          })
          .catch((err) => console.error("Error fetching user email:", err));
      });

      // Optional: Add functionality to Track Order button (currently just logs a click)
      trackOrderBtn.addEventListener("click", (event) => {
        event.preventDefault();
        console.log("Track Order button clicked");
      });

      // Global listener for postMessage to auto-close the modal when automation is complete.
      window.addEventListener("message", (event) => {
        if (event.data && event.data.action === "closeAutomationUI") {
          // Check if railway modal exists and remove it.
          const modal = document.getElementById("railway-modal");
          if (modal) {
            modal.remove();
            document.body.classList.remove("modal-active");
            console.log("Railway modal closed automatically:", event.data.message || "");
          }
        }
      });

      // Update iframe size on window resize
      window.addEventListener("resize", () => {
        if (isMobile()) {
          iframeContainer.style.width = "100vw";
          iframeContainer.style.height = "100vh";
          iframeContainer.style.left = "0";
          iframeContainer.style.transform = "none";
        } else {
          iframeContainer.style.width = "378px";
          iframeContainer.style.height = `${window.innerHeight}px`;
          iframeContainer.style.left = "50%";
          iframeContainer.style.transform = "translateX(-50%)";
        }
      });
    </script>
  </body>
</html>
